<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
          margin: 0;
          height: 100%;
          background: #111;
      }

      canvas {
          height: 100% !important;
          width: 100% !important;
          display: block;
      }
    </style>
    <script id="envmap_dispersion_pars_fragment" type="x-shader/x-fragment">
    uniform float dispersion;
    uniform float dispersionBlendMultiplier;
    uniform mat3 normalMatrix;

    // https://www.shadertoy.com/view/ll2GD3
    vec3 pal( in float t, in vec3 a, in vec3 b, in vec3 c, in vec3 d ) {
        return a + b*cos( 6.28318*(c*t+d) );
    }
    vec3 spectrum(float n) {
        return pal( n, vec3(0.5,0.5,0.5),vec3(0.5,0.5,0.5),vec3(1.0,1.0,1.0),vec3(0.0,0.33,0.67) );
    }
    uniform float time;

    vec3 hit(vec3 dir, vec3 normal, float ri) {
      vec3 refracted = refract( dir, normal, ri );
      if (refracted == vec3(0)) {
        // return normalize(vec3(1,1,1));
        return normalize(vec3(1,0,0));
        return reflect(dir, normal);
      }
      return refracted;
    }



    vec3 doSample2(vec3 normal) {
      vec2 uv = vec2(
        acos(dot(normal, vec3(1,0,0))),
        acos(dot(normal, vec3(0,1,0)))
      );

      vec3 col0 = vec3(223,236,255)/255.;
      vec3 col1 = vec3(1);
      vec3 col2 = vec3(121,162,208)/255.;
      vec3 col3 = vec3(18,37,70)/255.;
      
      // float t = time * .1;
      float t = 2.;
    
      vec2 uv2 = sin(uv * 25. + t) * .5 + .5;
      float c = uv2.x * uv2.y;
      c = step(.5, c);
    
      vec2 uv3 = sin(uv * 18. + vec2(t,0.)) * .5 + .5;
      float d = uv3.x * uv3.y;
      d = step(.5, d);
    
      vec2 uv4 = sin(uv * 25. + t) * .5 + .5;
      float e = uv4.x * uv4.y;
      e = step(.5, e);

      vec2 uv5 = sin(uv) * .5 + .5;
      float f = uv5.x * uv5.y;
      f = step(.9999999999, f*1.001);
    
      vec3 col = col0;
      // col = mix(col, col3, e);
      col = mix(col, col2, d);
      col = mix(col, col1, c);
      // col = mix(col, col3, f);

      return col;
    }


    vec4 doSample(vec3 dir) {
      float d = dot(dir, normalize(cameraPosition));
      float l = log(length(cameraPosition) / 5.);
      float start = mix(-.9, -.99, l) - .1;
      start = -.9975;
      float e = smoothstep(start * 1.001, start, d);
      vec4 blob = vec4(18, 37, 70, 255) / 255.;
      blob = vec4(121, 162, 220, 255) / 255.;
      blob = vec4(121,162,208,255)/255.;
      // blob = vec4(121, 162, 208, 255) / 255.;
      vec4 col = textureCube( envMap, vec3( flipEnvMap * dir.x, dir.yz ) );
      vec4 col3 = vec4(doSample2(dir),1);
      // return col3;
      col = mix(blob, col, e);
      return col;
    }

    </script>

    <script id="envmap_dispersion_fragment" type="x-shader/x-fragment">
    vec4 envColor = vec4(0);

    vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );
    vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
    
    // cameraToVertex = vec3(0,0,-1);
    // worldNormal = normal;


    for (int i = 0; i < DISPERSION_SAMPLES; i++) {

      float wavelength = float(i) / float(DISPERSION_SAMPLES);

      float riMax = refractionRatio * (1. + dispersion);
      float ri = mix(refractionRatio, riMax, wavelength);
      vec3 reflectVec = hit( cameraToVertex, worldNormal, ri );

      vec4 envColorSample = doSample(reflectVec);
      
      envColorSample = envMapTexelToLinear( envColorSample );
      envColorSample.rgb *= spectrum(wavelength - .15);
      envColorSample.rgb /= float(DISPERSION_SAMPLES) / dispersionBlendMultiplier;
      envColor.rgb += envColorSample.rgb / 10.;
    }

    vec4 col2 = vec4(0);

      vec3 reflectVec = hit( cameraToVertex, worldNormal, .7 );

    vec4 envColorSample = doSample(reflectVec);
            
      envColorSample = envMapTexelToLinear( envColorSample );
      col2.rgb = envColorSample.rgb;

      vec4 high = vec4(smoothstep(1.65, 1.7, length(col2))) * .1;

    envColor = envColor + (envColor * high * 2.);
    //envColor = envColor * col2;

    float g = envColor.g * (1.- envColor.r * envColor.b);
    g = smoothstep(0., .4, g);
    //envColor.g *= mix(1., .8, g);
    //envColor.rb *= mix(1., 1.5, 1.-g);

    // envColor = col2;

    // envColor = high;

    //envColor = vec4(smoothstep(.5, .3, length(col2)));

    outgoingLight = envColor.xyz;
    </script>
    <script src="lib/three.min.js"></script>
    <script src="lib/TrackballControls.js"></script>
    <script src="lib/seedrandom.min.js"></script>
  </head>
  <body>
    <script src="main.js"></script>
  </body>
</html>
